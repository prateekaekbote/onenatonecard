<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>OneNationOneCard — Web NFC Prototype</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  
  <style>
    body { font-family: system-ui, -apple-system, Roboto, Arial; padding: 16px; max-width: 880px; margin: auto; background: radial-gradient(1200px 600px at 10% -10%, #e6f0ff 0%, rgba(230,240,255,0) 60%), radial-gradient(1000px 500px at 110% 10%, #ffe9f0 0%, rgba(255,233,240,0) 60%), linear-gradient(180deg, #f7f9fc, #f4f6fb); color: #1b1f2a; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
    .card { border: 1px solid rgba(17, 24, 39, 0.08); padding: 16px; border-radius: 14px; margin-bottom: 16px; background: rgba(255,255,255,0.72); box-shadow: 0 8px 24px rgba(17,24,39,0.06), inset 0 1px 0 rgba(255,255,255,0.5); backdrop-filter: saturate(140%) blur(6px); }
    label { display:block; margin-top:10px; font-weight: 600; color:#111827; letter-spacing: 0.2px }
    input, button, textarea { width:100%; padding:12px; margin-top:6px; box-sizing:border-box; border:1px solid rgba(17,24,39,0.12); border-radius:10px; background:#ffffff; color:#111827; transition: border-color .2s ease, box-shadow .2s ease, transform .05s ease; }
    input:focus, textarea:focus { outline:none; border-color:#2563eb; box-shadow: 0 0 0 3px rgba(37,99,235,.15) }
    input[type="password"] { letter-spacing: 0.2em }
    button { cursor:pointer; background: linear-gradient(180deg, #2563eb, #1d4ed8); color:#fff; border: none; font-weight:700; letter-spacing:.2px; box-shadow: 0 6px 14px rgba(37,99,235,.25); }
    button:hover { filter: brightness(1.05) }
    button:active { transform: translateY(1px) }
    button:disabled { opacity:0.65; cursor:not-allowed; filter: grayscale(20%) }
    .row { display:flex; gap:10px }
    .small { width: 160px }
    pre { background:#0b1021; color:#e5e7eb; padding:12px; border-radius:10px; overflow:auto; max-height:280px; font-size:12px; border:1px solid rgba(255,255,255,0.08) }
    .hint { color:#4b5563; font-size:0.95rem }
    .disabled-section { opacity:0.5; pointer-events:none; }
    h2 { font-size: 1.8rem; line-height:1.2; margin: 8px 0 18px; letter-spacing:.2px }
    h3 { font-size: 1.2rem; margin: 0 0 12px; color:#0f172a }
    hr { border: none; height:1px; background: linear-gradient(90deg, rgba(17,24,39,0), rgba(17,24,39,.15), rgba(17,24,39,0)); margin: 14px 0 }
    @media (max-width: 640px) { body { padding: 12px; max-width: 100% } .row { flex-direction: column } }
    .split { display: grid; grid-template-columns: 1fr 1fr; gap: 16px }
    .pane { border: 1px solid rgba(17,24,39,0.06); border-radius: 12px; padding: 12px; background: rgba(255,255,255,0.6) }
    .pane h4 { margin: 0 0 8px; font-size: 1rem; color:#0f172a }
    .pill { display:inline-block; padding: 4px 8px; border-radius: 999px; font-size: 12px; font-weight: 700; letter-spacing:.2px; }
    .pill.info { background: rgba(37,99,235,.12); color:#1e40af; }
    .pill.success { background: rgba(16,185,129,.14); color:#065f46; }
    input[readonly] { background: #f9fafb }
    .muted { color:#6b7280 }
    @media (max-width: 860px) { .split { grid-template-columns: 1fr; } }
  </style>
  
  <noscript>
    <style>
      body { font-family: system-ui, -apple-system, Roboto, Arial; padding:20px }
      .nojs { padding:12px; border:1px solid #e11d48; background:#fef2f2; color:#7f1d1d; border-radius:8px }
    </style>
  </noscript>
</head>
<body>
  <h2>OneNationOneCard — Web NFC Prototype</h2>

  <div id="supportNotice" class="card"></div>

  <div class="card">
    <h3>1. Fetch details from Database</h3>
    <label>Enter Aadhaar No. <input id="aadhaar" placeholder="123456789012" value="123456789012"></label>
    <button id="fetchBtn">Fetch Data</button>
  </div>
  
  <div id="issuanceSection" class="card disabled-section">
    <h3>2. Request credential from issuer (server)</h3>
    <div class="split">
      <div class="pane">
        <h4>Your input <span class="pill info">you control this</span></h4>
        <label>PIN (for tag encryption) <input id="pin" value="7359" type="password"></label>
        <label>Expiry (optional) <input id="expiry" placeholder="2026-10-10"></label>
        <div class="row">
          <button id="requestBtn">Request Issuance (server)</button>
          <button id="writeBtn">Write to tag (after issuing)</button>
        </div>
        <p class="hint">Request issuance first to receive an encrypted blob, then write it to a tag.</p>
      </div>
      <div class="pane">
        <h4>Fetched from backend <span class="pill success">read‑only</span></h4>
        <label>Name <input id="name" readonly></label>
        <label>Sex <input id="sex" readonly></label>
        <label>DOB <input id="dob" readonly></label>
        <label>Voter ID <input id="voter_id" readonly></label>
        <label>PAN <input id="pan" readonly></label>
        <label>Driving License (DL) <input id="dl" readonly></label>
        <label>Photo hash <input id="phash" readonly></label>
        <p class="hint muted">Values above are populated from your database after Step 1.</p>
        <p class="hint"><strong>Response (server):</strong></p>
        <pre id="serverResp">--</pre>
      </div>
    </div>
  </div>

  <div class="card">
    <h3>3. Read & Verify from NFC tag</h3>
    <button id="readBtn">Read tag</button>
    <label>Enter PIN to decrypt <input id="verifyPin" type="password"></label>
    <div class="row">
      <button id="decryptVerifyBtn">Decrypt & Verify</button>
    </div>
    <p class="hint">Press Read tag, then touch the tag to the phone. After the raw blob appears, enter PIN and click Decrypt & Verify.</p>
    <p><strong>Tag raw:</strong></p>
    <pre id="tagRaw">--</pre>
    <p><strong>Decrypted credential (if successful):</strong></p>
    <pre id="credOut">--</pre>
  </div>

<script>
(async () => {
  const supportNotice = document.getElementById("supportNotice");
  const serverResp = document.getElementById("serverResp");
  const tagRaw = document.getElementById("tagRaw");
  const credOut = document.getElementById("credOut");

  const elements = {
      name: document.getElementById("name"),
      sex: document.getElementById("sex"),
      dob: document.getElementById("dob"),
      voter_id: document.getElementById("voter_id"),
      pan: document.getElementById("pan"),
      dl: document.getElementById("dl"),
      phash: document.getElementById("phash"),
      pin: document.getElementById("pin"),
      expiry: document.getElementById("expiry"),
      issuanceSection: document.getElementById("issuanceSection")
  };

  const hasNdefReader = 'NDEFReader' in window;
  const isSecure = window.isSecureContext === true;
  const nfcSupported = hasNdefReader && isSecure;
  if(!nfcSupported){
    let reason = [];
    if(!hasNdefReader) reason.push("NDEFReader API missing");
    if(!isSecure) reason.push("not a secure context (HTTPS/localhost required)");
    const why = reason.length ? ` (${reason.join(', ')})` : '';
    supportNotice.innerHTML = `<strong>Web NFC not available${why}.</strong>`;
  } else {
    supportNotice.innerHTML = `<strong>Web NFC detected.</strong> You can read & write tags.`;
  }

  let lastBlob = null;
  let lastIssuerPubPem = null;
  let lastTagText = null;

  document.getElementById("fetchBtn").addEventListener("click", async () => {
    const aadhaar = document.getElementById("aadhaar").value;
    if(!aadhaar) return alert("Please enter an Aadhaar number.");
    try {
        const res = await fetch("/api/fetch_user", {
            method: "POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify({ aadhaar: aadhaar })
        });
        const j = await res.json();
        if(res.ok){
            elements.name.value = j.name;
            elements.sex.value = j.sex;
            elements.dob.value = j.dob;
            elements.voter_id.value = j.voter_id;
            elements.pan.value = j.pan;
            elements.dl.value = j.dl;
            elements.phash.value = j.photo_hash;
            elements.issuanceSection.classList.remove("disabled-section");
            alert("Data fetched successfully. You can now request issuance.");
        } else {
            alert("Error: " + (j.error || "Unknown error"));
        }
    } catch(e) {
        console.error(e);
        alert("Request to fetch user failed: " + e);
    }
  });

  document.getElementById("requestBtn").addEventListener("click", async () => {
    const payload = {
      name: elements.name.value,
      sex: elements.sex.value,
      dob: elements.dob.value,
      voter_id: elements.voter_id.value,
      pan: elements.pan.value,
      dl: elements.dl.value,
      photo_hash: elements.phash.value,
      pin: elements.pin.value,
      expiry: elements.expiry.value || undefined
    };
    try {
      const res = await fetch("/api/issue_credential", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(payload)
      });
      const j = await res.json();
      serverResp.textContent = JSON.stringify(j, null, 2);
      if(j.tag_blob){
        lastBlob = j.tag_blob;
        lastIssuerPubPem = j.issuer_pub_pem;
        alert("Received blob from issuer. Now tap Write to write to tag.");
      } else {
        alert("Server error: " + JSON.stringify(j));
      }
    } catch(e){
      console.error(e);
      alert("Request failed: " + e);
    }
  });

  document.getElementById("writeBtn").addEventListener("click", async () => {
    if(!nfcSupported) return alert("Web NFC unsupported");
    if(!lastBlob) return alert("No blob available. Click 'Request Issuance' first.");
    try {
      const ndef = new NDEFReader();
      const encoder = new TextEncoder();
      const dataToWrite = encoder.encode(JSON.stringify(lastBlob));
      await ndef.write({
        records: [
          { recordType: "mime", mediaType: "application/vnd.onenation.cred", data: dataToWrite }
        ]
      });
      alert("Write successful.");
    } catch (e) {
      console.error(e);
      alert("Write failed: " + (e.message || e));
    }
  });

  document.getElementById("readBtn").addEventListener("click", async () => {
    if(!nfcSupported) return alert("Web NFC unsupported");
    try {
      const ndef = new NDEFReader();
      await ndef.scan();
      tagRaw.textContent = "(waiting for a tag — touch the tag to the phone)";
      ndef.onreadingerror = () => { alert("Read error"); };
      ndef.onreading = event => {
        const records = event.message.records;
        if(records.length === 0) { tagRaw.textContent = "(no records)"; return; }
        let out = [];
        for (const rec of records) {
          try {
            let text = "";
            if(rec.data){
              const dv = rec.data;
              const bytes = new Uint8Array(dv.buffer, dv.byteOffset, dv.byteLength);
              text = new TextDecoder().decode(bytes);
            }
            out.push({t: rec.recordType, m: rec.mediaType || null, d: text});
          } catch(e) {
            out.push({t: rec.recordType, err: String(e)});
          }
        }
        const first = out[0];
        lastTagText = first.d || "";
        tagRaw.textContent = JSON.stringify(out, null, 2);
      };
      alert("Scanning active — touch the tag to your phone now.");
    } catch(e){ console.error(e); alert("Scan failed: " + (e.message || e)); }
  });

  document.getElementById("decryptVerifyBtn").addEventListener("click", async () => {
    if(!lastTagText) return alert("No tag content available. Read a tag first.");
    const pin = document.getElementById("verifyPin").value;
    if(!pin) return alert("Enter PIN used at issuance.");
    let blob;
    try {
      blob = JSON.parse(lastTagText);
    } catch(e){ alert("Tag JSON parse error: " + e); return; }
    try {
      const salt = base64ToArray(blob.salt);
      const nonce = base64ToArray(blob.nonce);
      const ct = base64ToArray(blob.ct);
      const sigDer = base64ToArray(blob.sig);
      const keyBytes = await derivePBKDF2Key(pin, salt, 200000, 256);
      const plain = await aesGcmDecrypt(keyBytes, nonce, ct);
      const plainText = new TextDecoder().decode(plain);
      let issuerPem = lastIssuerPubPem;
      if(!issuerPem){
        issuerPem = prompt("Issuer public key missing. Paste issuer public key PEM here (from server response):");
        if(!issuerPem){ alert("Issuer public key required for verification."); return; }
      }
      const rawSig = derToRaw(sigDer, 32);
      const ok = await verifyEcdsaSignature(issuerPem, plain, rawSig);
      if(!ok) {
        credOut.textContent = "Signature INVALID";
      } else {
        credOut.textContent = plainText;
      }
    } catch (e) {
      console.error(e);
      alert("Decrypt/verify failed: " + (e.message || e));
    }
  });

  function base64ToArray(s){
    const bin = atob(s);
    const arr = new Uint8Array(bin.length);
    for(let i=0;i<bin.length;i++) arr[i] = bin.charCodeAt(i);
    return arr;
  }
  async function derivePBKDF2Key(pin, salt, iterations, bits){
    const enc = new TextEncoder();
    const baseKey = await window.crypto.subtle.importKey("raw", enc.encode(pin), {name:"PBKDF2"}, false, ["deriveBits","deriveKey"]);
    const derived = await window.crypto.subtle.deriveKey(
      { name: "PBKDF2", salt: salt, iterations: iterations, hash: "SHA-256" },
      baseKey, { name: "AES-GCM", length: bits }, true, ["encrypt","decrypt"]
    );
    const raw = await window.crypto.subtle.exportKey("raw", derived);
    return new Uint8Array(raw);
  }
  async function aesGcmDecrypt(keyBytes, nonce, ct){
    const cryptoKey = await window.crypto.subtle.importKey("raw", keyBytes, "AES-GCM", false, ["decrypt"]);
    const plain = await window.crypto.subtle.decrypt({name:"AES-GCM", iv: nonce}, cryptoKey, ct);
    return new Uint8Array(plain);
  }
  async function verifyEcdsaSignature(pem, messageBytes, rawSig){
    const pub = pemToArrayBuffer(pem);
    const key = await window.crypto.subtle.importKey("spki", pub, {name:"ECDSA", namedCurve:"P-256"}, false, ["verify"]);
    return await window.crypto.subtle.verify({name:"ECDSA", hash:"SHA-256"}, key, rawSig, messageBytes);
  }
  function pemToArrayBuffer(pem){
    const b64 = pem.replace(/-----(BEGIN|END) PUBLIC KEY-----/g, "").replace(/\s+/g, "");
    const bin = atob(b64);
    const arr = new Uint8Array(bin.length);
    for(let i=0;i<bin.length;i++) arr[i] = bin.charCodeAt(i);
    return arr.buffer;
  }
  function derToRaw(derBytes, partLen){
    const b = derBytes;
    if(b[0] !== 0x30) throw "Bad DER (not sequence)";
    let idx = 2;
    if(b[1] & 0x80){ const lenBytes = b[1] & 0x7f; idx = 2 + lenBytes; }
    if(b[idx] !== 0x02) throw "Bad DER (no int r)";
    const rLen = b[idx+1];
    const rStart = idx+2;
    const r = b.slice(rStart, rStart + rLen);
    const idx2 = rStart + rLen;
    if(b[idx2] !== 0x02) throw "Bad DER (no int s)";
    const sLen = b[idx2+1];
    const sStart = idx2+2;
    const s = b.slice(sStart, sStart + sLen);
    const rPadded = leftPad(r, partLen);
    const sPadded = leftPad(s, partLen);
    const raw = new Uint8Array(partLen*2);
    raw.set(rPadded, 0);
    raw.set(sPadded, partLen);
    return raw.buffer;
  }
  function leftPad(arr, len){
    if(arr.length === len) return arr;
    if(arr.length > len) return arr.slice(arr.length - len);
    const out = new Uint8Array(len);
    out.set(arr, len - arr.length);
    return out;
  }
})();
</script>
</body>
</html>